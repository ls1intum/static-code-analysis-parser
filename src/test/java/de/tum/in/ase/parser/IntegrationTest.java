package de.tum.in.ase.parser;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.xml.sax.SAXParseException;

import de.tum.in.ase.parser.exception.ParserException;
import de.tum.in.ase.parser.utils.XmlUtils;

/**
 * Tests each parser with an example file
 */
public class IntegrationTest {

    private final static String EXPECTED_FOLDER_PATH = "src/test/java/expected/";

    private final static String REPORTS_FOLDER_PATH = "src/test/java/reports/";

    /**
     * Compares the parsed JSON report with the expected JSON report
     * @param toolGeneratedReportFileName The name of the file contains the report as generated by the different tools
     * @param expectedJSONReportFileName  The name of the file that contains the parsed report
     * @throws ParserException If an exception occurs that is not already handled by the parser itself, e.g. caused by the json-parsing
     */
    private void testParserWithFile(String toolGeneratedReportFileName, String expectedJSONReportFileName) throws ParserException {
        File toolReport = new File(REPORTS_FOLDER_PATH + toolGeneratedReportFileName);

        ReportParser parser = new ReportParser();
        String actual = parser.transformToJSONReport(toolReport);

        try {
            BufferedReader reader = Files.newBufferedReader(Paths.get(EXPECTED_FOLDER_PATH + expectedJSONReportFileName));
            String expected = reader.readLine();
            assertEquals(expected, actual);
        }
        catch (IOException e) {
            e.printStackTrace();
            Assertions.fail();
        }
    }

    /**
     * Compares the parsed JSON report with the expected JSON report
     * @param fileName The name of the file contains the report as generated by the different tools
     * @param expected The expected output
     * @throws ParserException If an exception occurs that is not already handled by the parser itself, e.g. caused by the json-parsing
     */
    private void testParserWithString(String fileName, String expected) throws ParserException {
        File file = new File(REPORTS_FOLDER_PATH + fileName);
        ReportParser parser = new ReportParser();
        String actual = parser.transformToJSONReport(file);
        assertEquals(expected, actual);
    }

    @Test
    public void testCheckstyleParser() throws ParserException {
        testParserWithFile("checkstyle-result.xml", "checkstyle.txt");
    }

    @Test
    public void testPMDCPDParser() throws ParserException {
        testParserWithFile("cpd.xml", "pmd_cpd.txt");
    }

    @Test
    public void testPMDParser() throws ParserException {
        testParserWithFile("pmd.xml", "pmd.txt");
    }

    @Test
    public void testSpotbugsParser() throws ParserException {
        testParserWithFile("spotbugsXml.xml", "spotbugs.txt");
    }

    @Test
    public void testSwiftlintParser() throws ParserException {
        testParserWithFile("swiftlint-result.xml", "swiftlint.txt");
    }

    @Test
    public void testGCCParser() throws ParserException {
        testParserWithFile("gcc.xml", "gcc.txt");
    }

    @Test
    public void testParseInvalidFilename() throws ParserException {
        testParserWithFile("cpd_invalid.txt", "invalid_filename.txt");
    }

    @Test
    public void testParseInvalidXML() throws ParserException {
        String fileName = "invalid_xml.xml";
        Exception exception = assertThrows(SAXParseException.class, () -> XmlUtils.createDocumentBuilder().parse(new File(REPORTS_FOLDER_PATH + fileName)));
        try {
            String expectedInvalidXML = Files.newBufferedReader(Paths.get(EXPECTED_FOLDER_PATH + "invalid_xml.txt")).readLine();
            // JSON transform escapes quotes, so we need to escape them too
            testParserWithString("invalid_xml.xml", String.format(expectedInvalidXML, exception.toString().replaceAll("\"", "\\\\\"")));
        }
        catch (IOException e) {
            e.printStackTrace();
        }
    }

    @Test
    public void testInvalidName() throws ParserException {
        testParserWithFile("invalid_name.xml", "invalid_name.txt");
    }
}
